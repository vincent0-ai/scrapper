<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Scraper Dashboard{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Scraper Dashboard</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#favoritesModal">‚≠ê Favorites</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar with Search History -->
        <div class="col-md-2 bg-light p-3" style="min-height: 100vh; border-right: 1px solid #ddd;">
          <div class="sidebar-content">
            <h5>üìã Search History</h5>
            <div id="search-history" class="mt-3">
              <p class="text-muted small">No searches yet</p>
            </div>
            <button class="btn btn-sm btn-outline-danger mt-3 w-100" id="clear-history-btn">Clear History</button>
          </div>
        </div>
        <!-- Main Content -->
        <div class="col-md-10 mt-4">
            {% block content %}{% endblock %}
        </div>
      </div>
    </div>

    <!-- Favorites Modal -->
    <div class="modal fade" id="favoritesModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">‚≠ê My Favorites</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="favorites-list">
              <p class="text-muted">No favorites yet. Click the star icon on any result to add it!</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Load search history on page load
      document.addEventListener('DOMContentLoaded', function() {
        loadSearchHistory();
        loadFavorites();
      });

      function loadSearchHistory() {
        fetch('/search_history')
          .then(response => response.json())
          .then(data => {
            const historyDiv = document.getElementById('search-history');
            const history = data.history || [];
            
            if (history.length === 0) {
              historyDiv.innerHTML = '<p class="text-muted small">No searches yet</p>';
              return;
            }

            let html = '<div class="list-group list-group-sm">';
            history.slice(0, 15).forEach(item => {
              const time = new Date(item.timestamp);
              const timeStr = time.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
              const displayText = item.query.substring(0, 25) + (item.query.length > 25 ? '...' : '');
              html += `
                <button class="list-group-item list-group-item-action text-start py-2" 
                        data-history-type="${item.type}" 
                        data-history-query="${item.query}"
                        title="${item.query}">
                  <div class="d-flex justify-content-between align-items-center">
                    <small>${displayText}</small>
                    <small class="text-muted">${timeStr}</small>
                  </div>
                </button>
              `;
            });
            html += '</div>';
            historyDiv.innerHTML = html;

            // Add click handlers
            document.querySelectorAll('[data-history-type]').forEach(btn => {
              btn.addEventListener('click', function() {
                const type = this.dataset.historyType;
                const query = this.dataset.historyQuery;
                repeatSearch(type, query);
              });
            });
          });
      }

      function repeatSearch(type, query) {
        if (type === 'lyrics' || type === 'simpmusic') {
          // Find and fill the form
          const form = type === 'lyrics' ? document.getElementById('lyrics-form') : document.getElementById('simpmusic-form');
          const input = form.querySelector('input[name="query"]');
          input.value = query;
          form.submit();
        } else if (type === 'medium') {
          const form = document.getElementById('medium-form');
          const input = form.querySelector('input[name="url"]');
          input.value = query;
          form.submit();
        }
      }

      function loadFavorites() {
        fetch('/favorites')
          .then(response => response.json())
          .then(data => {
            const favsList = document.getElementById('favorites-list');
            const favorites = data.favorites || [];
            
            if (favorites.length === 0) {
              favsList.innerHTML = '<p class="text-muted">No favorites yet. Click the star icon on any result to add it!</p>';
              return;
            }

            let html = '<div class="list-group">';
            favorites.forEach(fav => {
              const time = new Date(fav.timestamp);
              const timeStr = time.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
              html += `
                <div class="list-group-item">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="mb-1">${fav.title}</h6>
                      <small class="text-muted">${fav.type} ‚Ä¢ ${timeStr}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-fav-btn" data-item-id="${fav.item_id}">Remove</button>
                  </div>
                </div>
              `;
            });
            html += '</div>';
            favsList.innerHTML = html;

            // Add remove handlers
            document.querySelectorAll('.remove-fav-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                removeFavorite(itemId);
              });
            });
          });
      }

      function removeFavorite(itemId) {
        fetch('/remove_favorite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `item_id=${encodeURIComponent(itemId)}`
        })
        .then(response => response.json())
        .then(data => {
          loadFavorites();
        });
      }

      document.getElementById('clear-history-btn')?.addEventListener('click', function() {
        if (confirm('Clear all search history?')) {
          fetch('/clear_search_history', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
              loadSearchHistory();
            });
        }
      });

      // Handle favorite button clicks (dynamically added)
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('favorite-btn')) {
          const btn = e.target;
          const itemType = btn.dataset.type;
          const itemId = btn.dataset.itemId;
          const title = btn.dataset.title;

          fetch('/add_favorite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `type=${encodeURIComponent(itemType)}&item_id=${encodeURIComponent(itemId)}&title=${encodeURIComponent(title)}`
          })
          .then(response => response.json())
          .then(data => {
            btn.style.display = 'none';
            const removeBtn = btn.nextElementSibling;
            if (removeBtn && removeBtn.classList.contains('favorite-btn-remove')) {
              removeBtn.style.display = 'inline-block';
            }
            loadFavorites();
          });
        }
        
        if (e.target.classList.contains('favorite-btn-remove')) {
          const btn = e.target;
          const itemId = btn.dataset.itemId;

          fetch('/remove_favorite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `item_id=${encodeURIComponent(itemId)}`
          })
          .then(response => response.json())
          .then(data => {
            btn.style.display = 'none';
            const addBtn = document.querySelector(`.favorite-btn[data-item-id="${itemId}"]`);
            if (addBtn) {
              addBtn.style.display = 'inline-block';
            }
            loadFavorites();
          });
        }
      });
    </script>
  </body>
</html>
